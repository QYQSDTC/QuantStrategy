# 缩量十字星反转策略说明文档

## 📋 策略概述

缩量十字星反转策略是一个基于技术分析的量化选股策略，专门识别股票在下跌趋势中的反转信号。该策略通过识别特定的K线形态（十字星）、成交量特征（缩量）和技术指标确认，在市场情绪共振的条件下筛选优质买入标的。

### 🎯 核心理念

- **十字星形态**：识别多空平衡的关键转折点
- **缩量确认**：验证市场犹豫和抛压减轻
- **反转确认**：等待明确的向上突破信号
- **情绪共振**：在市场活跃时机执行选股
- **智能评分**：多维度评分筛选最优标的

## 🔄 当前选股模式总结

### 系统特点：
- **全市场扫描**：覆盖4000+只A股主板股票
- **双重筛选**：市场情绪 + 技术分析
- **智能评分**：100+分精选机制
- **防风控设计**：稳定的数据获取策略
- **实时输出**：详细的分析过程和结果

### 选股逻辑：
1. **情绪检测**：监控市场是否存在7日涨幅>60%的热门股票
2. **形态识别**：严格筛选符合十字星形态的标的
3. **量能验证**：确认缩量特征，验证抛压减轻
4. **反转确认**：价格突破十字星高点，阳线确认
5. **技术过滤**：MACD金叉 + KDJ非超买 + 均线配合
6. **综合评分**：多维度量化评分，选择最优标的

### 输出结果：
- **实时选股**：基于指定日期的股票筛选
- **详细评分**：每只股票的完整评分详情
- **风险提示**：市场情绪判断和操作建议
- **数据保存**：CSV文件和日志记录

## 🔍 策略原理

### 1. 十字星形态识别

十字星是一种重要的反转信号，表示多空双方力量平衡：

#### 标准十字星条件：
- **实体大小** < 1%（开盘价与收盘价差距极小）
- **上下影线**：必须同时存在明显的上下影线
- **形态判断**：
  - 若收盘价 ≥ 开盘价：最高价 > 收盘价，最低价 < 开盘价
  - 若收盘价 < 开盘价：最高价 > 开盘价，最低价 < 收盘价

#### 评分机制：
- 实体 < 0.5%：20分（极小实体）
- 实体 < 1.0%：15分（小实体）
- 上下影线 > 2%：15分（明显影线）
- 上下影线 > 1%：10分（有影线）

### 2. 缩量条件

缩量表示市场参与度降低，抛压减轻：

- **判断标准**：十字星当日成交量 < 20日平均成交量
- **评分机制**：
  - 量比 < 0.5：20分（大幅缩量）
  - 量比 < 0.8：15分（明显缩量）
  - 其他情况：10分（缩量）

### 3. 反转确认机制

确保反转信号的有效性：

- **价格确认**：确认日收盘价 > 十字星日最高价
- **K线确认**：确认日必须为阳线（收盘价 > 开盘价）
- **评分机制**：
  - 反转幅度 > 3%：20分（强势反转）
  - 反转幅度 > 1%：15分（有效反转）
  - 其他情况：10分（反转确认）

### 4. 技术指标过滤

#### DEA指标条件：
- 今日DEA > 昨日DEA（动能改善）
- DEA < 0（仍在负值区域）
- MACD > DEA（金叉趋势）

#### KDJ指标条件：
- J值 < 90（J = 3K - 2D）
- 避免在超买状态买入

#### 均线系统：
- **5日均线**：短期趋势判断
- **20日均线**：中期趋势参考
- **30日均线**：长期趋势和止损线

## 📊 评分体系

### 技术面评分（最高可达100+分）：

#### 开盘价位置评分：
- 开盘价低于30日线：+20分（低位启动）
- 开盘价低于20日线：+10分

#### 收盘价位置评分：
- 收盘价高于30日线：+10分（突破确认）
- 收盘价高于20日线：+20分

#### 均线排列：
- 5日线 > 20日线 > 30日线：+20分（多头排列）

#### DEA改善：
- DEA改善幅度 > 0.02：+15分（明显改善）
- DEA增大：+10分

#### 确认日表现：
- 确认日涨幅 > 9%：+20分（大涨）
- 确认日涨幅 > 5%：+10分（上涨）
- 确认日放量 > 6倍：+10分（大幅放量）

### 筛选标准：
**仅选择总评分 > 100分的股票**

## 🌊 市场情绪共振机制

### 情绪判断标准：
- **活跃标准**：市场存在7日涨幅超过60%的热门股票
- **共振逻辑**：情绪活跃 + 十字星反转信号 = 执行买入
- **保护机制**：情绪平淡时暂停所有买入操作

### 情绪分析输出：
- 实时监控市场最大7日涨幅
- 识别并记录热门股票列表
- 自动判断是否满足情绪共振条件

## 💰 资金管理

### 仓位控制：
- **最大持仓**：3只股票
- **权重分配**：等权重，每只股票占总资产的1/3
- **最小买入**：5000元或100股（取较大值）

### 买入逻辑：
1. 检查当前持仓数量
2. 按评分排序选择最优标的
3. 计算目标买入金额
4. 次日开盘价执行买入

## 🛡️ 风险控制

### 止损机制：
1. **均线止损**：跌破30日均线时卖出
2. **放量大跌**：成交量超过前一天1.6倍且当天下跌5%以上
3. **异常放量**：当天成交量超过前一天3倍

### 风险特征：
- **最大回撤控制**：通过严格止损限制单笔损失
- **分散投资**：最多持有3只股票，降低个股风险
- **趋势跟随**：均线系统确保大趋势一致性

## 🔧 技术实现与选股模式

### 当前选股系统架构：

#### 1. 数据获取模块
- **数据源**：akshare `stock_zh_a_hist` 接口
- **数据范围**：A股主板股票（排除创业板300、科创板688、ST股票）
- **数据周期**：日线数据，前复权处理
- **历史深度**：获取60天历史数据用于技术指标计算
- **防风控机制**：每100个股票休眠10秒，防止API限制

#### 2. 双重筛选体系

##### 🌊 市场情绪分析（第一层过滤）
```python
def market_sentiment_analysis():
    """实时监控市场热度，确定操作时机"""
    # 扫描全市场寻找7日涨幅超过60%的热门股票
    # 记录最大7日涨幅，判断市场情绪是否活跃
    # 只有在情绪共振条件下才执行选股
```

**情绪判断标准：**
- 存在7日涨幅 > 60%的热门股票
- 记录热门股票数量和最大涨幅
- 情绪活跃时开启选股，平淡时暂停操作

##### 🎯 十字星反转选股（第二层精选）
```python
def check_doji_reversal_signal(data, symbol):
    """多维度评分筛选优质标的"""
    # 严格的四步验证 + 复合评分体系
    # 只返回总评分 > 100分的高质量信号
```

### 3. 技术指标体系

#### 核心技术栈：
- **数据源**：akshare（A股历史数据）
- **技术指标**：TA-Lib
- **数据处理**：pandas
- **可视化**：matplotlib

#### 技术指标配置：
- **MA5/MA20/MA30**：移动平均线系统（趋势判断）
- **MACD/DEA**：动量指标（动能分析）
- **KDJ**：随机指标（超买超卖）
- **RSI**：相对强弱指标（强度判断）
- **成交量均线**：Volume MA10/MA20（量能分析）

### 4. 四步验证选股流程

#### 第一步：十字星形态识别
- **实体判断**：K线实体 < 1%（极小实体优先）
- **影线验证**：必须同时存在上下影线
- **形态确认**：严格区分阳线十字星和阴线十字星

#### 第二步：缩量条件验证
- **缩量标准**：十字星日成交量 < 20日均量
- **量能评估**：量比越低，评分越高

#### 第三步：反转信号确认
- **价格突破**：确认日收盘价 > 十字星日最高价
- **K线验证**：确认日必须为阳线
- **强度评估**：突破幅度越大，评分越高

#### 第四步：技术指标过滤
- **DEA条件**：DEA增大 + DEA<0 + MACD>DEA（金叉趋势）
- **KDJ条件**：J值 < 90（避免超买区域）
- **均线系统**：综合5/20/30日线位置关系

### 5. 复合评分体系（总分>100筛选）

#### 基础评分（45-65分）：
- **十字星质量**：15-35分
  - 极小实体(<0.5%)：20分
  - 小实体(<1.0%)：15分
  - 明显上下影线(>2%)：+15分
  - 有上下影线(>1%)：+10分

- **缩量程度**：10-20分
  - 大幅缩量(<0.5倍)：20分
  - 明显缩量(<0.8倍)：15分
  - 缩量：10分

- **反转强度**：10-20分
  - 强势反转(>3%)：20分
  - 有效反转(>1%)：15分
  - 反转确认：10分

#### 技术面加分（0-50+分）：
- **开盘价位置**：最高30分
  - 低于30日线：+20分
  - 低于20日线：+10分

- **收盘价表现**：最高45分
  - 大幅超过30日线(>10%)：+25分
  - 明显超过30日线(>5%)：+20分
  - 适度超过30日线(>2%)：+15分
  - 突破20日线：+20分

- **均线排列**：+20分
  - 5日线>20日线>30日线

- **MACD改善**：10-15分
  - DEA明显改善(>0.02)：15分
  - DEA增大：10分

- **确认日表现**：最高30分
  - 确认日大涨(>9%)：+20分
  - 确认日上涨(>5%)：+10分
  - 确认日大幅放量(>6倍)：+10分

### 6. 智能风控与执行

#### 数据获取风控：
- **请求频率**：每股票间隔100ms
- **批次休眠**：每100股票休眠10秒
- **错误处理**：3次重试机制
- **异常监控**：实时统计成功率

#### 执行流程控制：
- **预检验证**：测试数据获取可用性
- **进度监控**：实时显示筛选进度
- **结果保存**：CSV详细数据 + 日志记录
- **风险提示**：数据质量评估和警告

#### 输出文件系统：
- **详细结果**：`daily_screening_YYYYMMDD.csv`
- **选股日志**：`daily_screening.log`
- **进度日志**：实时控制台输出

## 📈 回测设置

### 回测参数：
- **回测期间**：2023-01-01 至今
- **初始资金**：100万元
- **交易费用**：按实际券商费率
- **基准对比**：沪深300指数

### 数据范围：
- **股票池**：A股主板股票（排除ST、退市股）
- **数据频率**：日线数据
- **复权方式**：前复权

## 📊 性能评估

### 关键指标：
- **总收益率**：策略期间累计收益
- **年化收益率**：年化后的收益表现
- **最大回撤**：最大亏损幅度
- **夏普比率**：风险调整后收益
- **胜率**：盈利交易占比
- **超额收益**：相对沪深300的超额表现

### 输出文件：

#### 选股系统输出：
- `daily_screening_YYYYMMDD.csv`：每日选股详细结果
- `daily_screening.log`：选股过程和结果日志
- 控制台实时输出：进度监控和防风控状态

#### 回测系统输出：
- `yang_bao_yin_backtest_results.png`：收益曲线图
- `yang_bao_yin_trade_records.csv`：详细交易记录
- `daily_stock_selection.log`：每日选股记录
- `trading_log.log`：交易执行日志
- `market_sentiment.log`：市场情绪分析记录

#### 典型选股输出示例：
```
📊 2024-01-15 缩量十字星反转选股结果 (全市场扫描)
================================================================================
📊 数据统计:
   分析日期: 2024-01-15
   总计股票: 4523 只
   成功获取数据: 4235 只
   获取失败: 288 只
   情绪分析有效: 4180 只
   十字星分析有效: 4120 只
   数据获取成功率: 93.6%

📈 市场情绪分析:
   最大7日涨幅: 85.6%
🔥 市场情绪: 活跃 ✅ (发现 15 只热门股票)
   ✅ 情绪共振条件满足，可执行十字星反转选股

🎯 十字星选股结果: 共发现 8 只符合条件的股票

📈 推荐股票 (前10名):
--------------------------------------------------------------------------------
 1. 万科A(000002)
    💯 总评分: 125分
    🔍 得分详情:
       • 十字星质量: 35分
       • 缩量程度: 20分
       • 反转强度: 15分
       • 技术面加分: 55分
    📅 十字星日期: 2024-01-12 → 确认日期: 2024-01-15
    📊 十字星实体: 0.3% | 缩量比例: 0.45
    📈 反转幅度: 2.8% | 确认日涨幅: 6.2%
    💰 当前价格: ¥15.68
    🎯 DEA: -0.0156 → -0.0098 (改善0.0058)
    📊 KDJ-J值: 45.2 | 确认日放量: 3.2倍
    📈 超越30日线: +3.2%
    ✨ 优势: 极小实体, 明显上下影线, 大幅缩量, 有效反转, 开盘价低于30日线, 收盘价适度超过30日线, DEA明显改善, 确认日上涨
```

## 🚀 使用指南

### 环境准备：
```bash
pip install akshare TA-Lib pandas matplotlib numpy
```

### 核心脚本说明：

#### 1. 每日选股脚本 (`daily_stock_screener.py`)
**功能**：基于指定日期进行全市场扫描选股

**运行方式**：
```bash
# 使用今日作为分析日期
python daily_stock_screener.py

# 指定特定日期
python daily_stock_screener.py -d 2024-01-15

# 交互式输入日期
python daily_stock_screener.py -i

# 开启调试模式
python daily_stock_screener.py -d 2024-01-15 --debug
```

**执行流程**：
1. **预检测试**：验证数据获取功能可用性
2. **获取股票池**：A股主板股票列表（约4000-5000只）
3. **双重分析**：
   - 市场情绪分析（扫描热门股票）
   - 十字星反转选股（多维度评分）
4. **防风控处理**：每100股票休眠10秒
5. **结果输出**：控制台显示 + 文件保存

#### 2. 回测分析脚本 (`backetest.py`)
**功能**：历史回测验证策略有效性

### 选股参数配置：

#### 日期参数：
- **目标日期**：分析基准日（确认日）
- **十字星日**：目标日期的前一天
- **历史数据**：获取60天数据用于技术指标计算

#### 筛选参数：
- **评分阈值**：总分 > 100分
- **数据要求**：至少22天历史数据
- **技术指标**：MA5/20/30, MACD/DEA, KDJ, RSI
- **成交量**：需要20日均量数据

#### 防风控参数：
- **请求间隔**：100ms/股票
- **批次休眠**：每100股票休眠10秒
- **重试机制**：失败最多重试3次
- **超时处理**：网络错误递增等待

## ⚠️ 风险提示

### 策略风险：
1. **市场风险**：策略无法预测极端市场情况
2. **模型风险**：历史表现不代表未来收益
3. **流动性风险**：部分股票可能存在流动性问题
4. **技术风险**：数据延迟或错误可能影响决策

### 使用建议：
1. **充分回测**：在不同市场环境下验证策略
2. **小额试验**：先用小资金验证实盘效果
3. **持续监控**：定期检查策略表现和市场适应性
4. **风险控制**：严格执行止损，控制单笔损失

## 📞 技术支持

### 日志系统：
- **选股日志**：记录每日选股过程和结果
- **交易日志**：记录所有买入卖出操作
- **情绪日志**：记录市场情绪分析结果

### 调试功能：
- 详细的评分机制输出
- 实时的技术指标计算
- 完整的决策过程记录

---

**免责声明**：本策略仅供学习和研究使用，不构成投资建议。投资有风险，入市需谨慎。使用者应根据自身情况谨慎决策，并承担相应风险。 